name: Deploy
run-name: "üöÄ Deploy by ${{ github.actor }} to Goldwise [${{ github.ref_name }}]"

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: üöÄ Deploy to Server
        env:
          SSH_USER: ${{ secrets.GOLDWISE_USER }}
          SSH_IP: ${{ secrets.GOLDWISE_IP }}
          SSH_PORT: ${{ secrets.GOLDWISE_PORT }}
          SSH_PASSWORD: ${{ secrets.GOLDWISE_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p "$SSH_PORT" $SSH_USER@$SSH_IP <<EOF
            echo "üîê Logged in via SSH"
            cd api.goldwisejewelry.com

            echo "üîç Detecting remote and branch..."
            REMOTE_URL=\$(git remote get-url origin)
            echo "üîó Remote URL: \$REMOTE_URL"

            BRANCH=\$(git rev-parse --abbrev-ref HEAD)
            echo "üåø Current Branch: \$BRANCH"

            echo "üîß Preparing new remote with token..."
            TOKEN_REMOTE=\$(echo "\$REMOTE_URL" | sed -E "s#https://(.*)#https://$GITHUB_TOKEN@\\1#")
            echo "üîó Token Remote: \$TOKEN_REMOTE"

            git remote set-url origin "\$TOKEN_REMOTE"

            echo "üì• Pulling from \$BRANCH..."
            GIT_TERMINAL_PROMPT=0 git pull origin "\$BRANCH"

            echo "üîÅ Resetting remote to original (no token)..."
            git remote set-url origin "\$REMOTE_URL"

            echo "üì¶ Running Composer install..."
            composer install --no-interaction --prefer-dist

            echo "‚öôÔ∏è Artisan setup..."
            php artisan optimize:clear
            php artisan migrate:fresh --force
            php artisan db:seed --force
            php artisan optimize:clear

            echo "‚úÖ Deployment Complete"
          EOF
